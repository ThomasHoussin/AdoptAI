name: Claude Issue Auto-Triage

# This workflow automatically analyzes new issues and provides initial responses
# It helps with:
# - Identifying known issues and providing solutions
# - Asking for clarification when needed
# - Triaging bugs vs feature requests vs support questions

on:
  issues:
    types: [opened]

jobs:
  triage-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Issue Analysis
        id: claude-triage
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ISSUE TRIAGE TASK

            A new issue has been opened on the AdoptAI API repository:

            **Issue Title**: ${{ github.event.issue.title }}
            **Issue Number**: #${{ github.event.issue.number }}
            **Issue URL**: ${{ github.event.issue.html_url }}
            **Author**: @${{ github.event.issue.user.login }}

            **Issue Body**:
            ${{ github.event.issue.body }}

            ---

            YOUR TASK:

            1. **Analyze the issue** using the information in CLAUDE.md for project context

            2. **Categorize** the issue as one of:
               - KNOWN_ISSUE: Matches a documented known issue
               - BUG_REPORT: New bug that needs investigation
               - FEATURE_REQUEST: Enhancement or new functionality request
               - SUPPORT_QUESTION: User needs help with API usage
               - NEEDS_INFO: Not enough information to determine the issue
               - NOT_RELEVANT: Spam or off-topic

            3. **Check for key information**:
               - API endpoint being used (/sessions, /speakers, /health)
               - Error messages or HTTP status codes
               - Query parameters used
               - Expected vs actual behavior
               - Steps to reproduce

            4. **Respond appropriately** using `gh issue comment`:

               For KNOWN_ISSUE:
               - Explain the issue clearly
               - Reference the specific known issue from CLAUDE.md
               - Provide the solution or workaround
               - Add appropriate labels using `gh issue edit --add-label`

               For BUG_REPORT:
               - Thank the user for reporting
               - Confirm it's a valid bug
               - Add label "bug" using `gh issue edit --add-label`
               - Ask if any critical information is missing

               For FEATURE_REQUEST:
               - Thank the user for the suggestion
               - Ask for clarification on use case if needed
               - Add label "enhancement" using `gh issue edit --add-label`

               For SUPPORT_QUESTION:
               - Provide helpful guidance
               - Reference API documentation (llms.txt)
               - Add label "question" using `gh issue edit --add-label`

               For NEEDS_INFO:
               - Politely ask for the missing information
               - Use a checklist format for what's needed:
                 * API endpoint
                 * Query parameters
                 * Error message
                 * Expected behavior
                 * Steps to reproduce
               - Add label "needs-info" using `gh issue edit --add-label`

               For NOT_RELEVANT:
               - Politely explain why it's not relevant
               - Close the issue using `gh issue close`

            5. **Be helpful and professional**:
               - Use friendly, clear language
               - Reference specific files/code when relevant (use file:line format)
               - Provide actionable next steps
               - Don't make promises about fixes without maintainer confirmation

            6. **Use these gh commands**:
               ```bash
               # To comment on the issue
               gh issue comment ${{ github.event.issue.number }} --body "Your message here"

               # To add labels
               gh issue edit ${{ github.event.issue.number }} --add-label "bug"
               gh issue edit ${{ github.event.issue.number }} --add-label "enhancement"
               gh issue edit ${{ github.event.issue.number }} --add-label "question"
               gh issue edit ${{ github.event.issue.number }} --add-label "needs-info"

               # To close if not relevant
               gh issue close ${{ github.event.issue.number }} --reason "not planned" --comment "Reason for closing"
               ```

            IMPORTANT:
            - Read CLAUDE.md carefully for project context and API structure
            - Be conservative: if unsure, ask for more information rather than making assumptions
            - Don't claim issues are fixed unless you can verify in the codebase
            - Use HEREDOC for multi-line comments to avoid quoting issues

          # Restrict Claude to only use necessary tools
          claude_args: '--allowed-tools "Bash(gh issue comment:*),Bash(gh issue edit:*),Bash(gh issue close:*),Bash(gh issue view:*),Read,Grep,Glob"'
